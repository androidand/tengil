---
# Eclipse Mosquitto OCI Container Package
# Lightweight MQTT message broker for IoT devices
#
# Usage:
#   tg apply packages/mosquitto-oci.yml

name: mosquitto
type: oci
version: latest

oci:
  image: eclipse-mosquitto
  tag: latest
  registry: docker.io

# Container configuration
hostname: mosquitto
cores: 1
memory: 256
disk: 4

# Resource pool (optional)
# pool: automation

# Network configuration
network:
  bridge: vmbr0
  ip: dhcp

# Security
unprivileged: true

# Features
features:
  nesting: false

# Mount configuration and data
mounts:
  - source: /tank/config/mosquitto/config
    target: /mosquitto/config
    readonly: false
  - source: /tank/config/mosquitto/data
    target: /mosquitto/data
    readonly: false
  - source: /tank/config/mosquitto/log
    target: /mosquitto/log
    readonly: false

# Auto-created volumes (by OCI):
# - /mosquitto/config (mosquitto.conf, password files, ACLs)
# - /mosquitto/data (persistent messages)
# - /mosquitto/log (broker logs)

# Post-deployment:
# 1. Create mosquitto.conf in /mosquitto/config/
# 2. Set up authentication:
#    pct exec <vmid> -- mosquitto_passwd -c /mosquitto/config/passwd username
# 3. Configure ACLs for access control (optional)
# 4. Test connection: mosquitto_sub -h <container-ip> -t test/topic
# 5. Publish test message: mosquitto_pub -h <container-ip> -t test/topic -m "Hello"

# Verification:
# - Check broker status: pct exec <vmid> -- netstat -tuln | grep 1883
# - Test MQTT connection with mosquitto_sub/pub
# - Monitor logs: pct exec <vmid> -- tail -f /mosquitto/log/mosquitto.log
# - Verify authentication if enabled

# Example mosquitto.conf:
# # Network settings
# listener 1883 0.0.0.0
# protocol mqtt
# 
# # Security
# allow_anonymous false
# password_file /mosquitto/config/passwd
# 
# # Persistence
# persistence true
# persistence_location /mosquitto/data/
# 
# # Logging
# log_dest file /mosquitto/log/mosquitto.log
# log_type all
# log_timestamp true
# 
# # WebSockets (optional)
# listener 9001
# protocol websockets

# MQTT ports:
# - 1883: Standard MQTT (unencrypted)
# - 8883: MQTT over TLS
# - 9001: WebSocket (for browser clients)

# Common use cases:
# - Home Assistant MQTT broker
# - Zigbee2MQTT message bus
# - IoT device communication
# - ESPHome sensor data
# - Node-RED automation flows

# Integration examples:
# - Home Assistant: Configuration > Integrations > MQTT
# - Zigbee2MQTT: Set mqtt.server in configuration.yaml
# - ESPHome: mqtt: broker: <container-ip>
